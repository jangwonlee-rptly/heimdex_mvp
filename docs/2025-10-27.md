# Heimdex Repository Notes — 2025-10-27 (refreshed)

## Overview
- Heimdex turns uploaded video into structured “sidecar” metadata (ffprobe details + thumbnail manifests) and stores derived artefacts for later retrieval.
- A FastAPI application under `/v1/*` orchestrates ingest, asset state, and async job execution; legacy `/metadata` routes are gated behind a feature toggle and disabled by default.
- Configuration is entirely `.env` driven. Copying one of the provided templates and running `docker compose --profile dev up -d` is sufficient to boot the stack locally.

## High-Level Architecture
- **App factory (`app/main.py`):** Loads settings, configures structlog logging, initialises storage/DB/session factory, and mounts the versioned router. Legacy routes are only added when `HEIMDEX_ENABLE_LEGACY=true`.
- **Routing (`app/api/v1`)**  
  - `routes_system.py`: `/v1/health` for liveness checks.  
  - `routes_admin.py`: `/v1/admin/env-check` plus a development-only `/v1/admin/dev-token` that mints HS256 JWTs when `HEIMDEX_ENV=development`.  
  - `routes_ingest.py`: init/commit/probe endpoints with plug-in storage scheme validation.  
  - `routes_assets.py`: thumbnail and sidecar job enqueues, asset snapshots, and stored sidecar retrieval.  
  - `routes_jobs.py`: job status inspection.  
- **Services (`app/services/ingest_service.py`):** Handles ingest orchestration, asset persistence, ffprobe parsing, thumbnail generation, and job lifecycle updates.
- **Domain helpers (`app/domain/*`, `app/ingest/*`):** Shared logic for asset IDs, ffprobe normalisation, sidecar schema export, and thumbnail rendering.
- **Jobs (`app/core/jobs.py`, `app/workers/tasks.py`):** Abstract job backend (inline vs RQ) and worker entry point. Inline execution remains the default; RQ integration is ready for Redis-based queues.
- **Configuration (`app/core/config.py`):** Pydantic `Settings` with `.env` loading, alias support for legacy env names, computed storage schemes, and runtime logging/auth parameters.
- **Storage (`app/core/storage.py`):** `LocalStorage` (filesystem) for dev, `GCSStorage` skeleton for future cloud integration.
- **Database (`app/core/db.py`, `app/db/models.py`):** SQLAlchemy async stack with Alembic migrations under `migrations/`. Default dev setup targets Postgres (`vna-postgres`).

## Configuration & Runtime Environment
- `.env` templates (`.env.example.dev|staging|prod`) supply opinionated defaults:
  - Dev uses local auth (`HEIMDEX_AUTH_PROVIDER=local`), inline jobs, and filesystem storage.
  - Staging/Prod templates switch to GCS storage and Firebase/OIDC tokens (placeholders provided).
- `app/core/config.py` calls `dotenv.load_dotenv()` on every settings fetch and normalises legacy env names (e.g., `HEIMDEX_DB_URL` ⇒ `HEIMDEX_DATABASE_URL`).
- `docker-compose.yml`:
  - Profiles: `dev` spins up Postgres, Redis, and the API container (`vna`).
  - Uses `env_file: .env`; no shell exports required.
  - Bind-mounts `./derived` into `/app/derived` so ingest uploads staged locally are visible inside the container.
- `Makefile` helpers:
  - `make dev-up`, `make dev-down`, `make test` wrap the compose commands and local test execution.

## API Surface Details
- **Admin**  
  - `/v1/admin/env-check`: ffmpeg/ffprobe/PySceneDetect availability. Requires a JWT with `scopes` containing `admin`.  
  - `/v1/admin/dev-token`: Only in development mode; accepts `{org_id, scopes?, user_id?}` and returns a signed JWT using `HEIMDEX_JWT_SECRET`. Helps local testing without external token tooling.
- **Ingest**  
  - `/v1/ingest/init`: Creates an org (if needed) and returns `upload_id` plus `presigned.asset_uri`. For local storage this is a `file:///app/derived/uploads/...` path.  
  - Populate the returned path on the host under `derived/...` before calling `/v1/ingest/commit`.  
  - `/v1/ingest/commit`: Validates allowed URI schemes (file-only for local backend, gs/file when GCS enabled) and persists asset metadata. GCS paths currently raise `NotImplementedError`.  
  - `/v1/ingest/probe`: Returns sidecar JSON computed on demand; same scheme validation rules apply.
- **Assets/Jobs**  
  - `/v1/assets/{asset_id}`: Fetch persisted metadata, including storage pointers for sidecars/thumbnails.  
  - `/v1/assets/{asset_id}/thumbnails` and `/v1/assets/{asset_id}/sidecar`: enqueue background jobs (inline by default). Idempotency enforced via `Idempotency-Key` header.  
  - `/v1/jobs/{job_id}`: Inspect job status, result payload, or error info.
- **Legacy**  
  - Inline `/metadata` upload route remains for backward compatibility but is deactivated unless `HEIMDEX_ENABLE_LEGACY=true`.

## Storage & Files
- **Local flow:** `LocalStorage` writes under `<derived_root>/uploads`, `<derived_root>/<org>/<asset>/thumbs`, etc. Sidecars land in `<derived_root>/<org>/sidecars`.  
- **GCS stub:** `GCSStorage` exposes URI parsing and raises `NotImplementedError` for read/write/presign operations—enough to unblock upstream validation while signalling missing implementation paths.  
- Allowed URI schemes derive from the active backend but can be force-overridden via `HEIMDEX_ALLOWED_SOURCE_URI_SCHEMES`.

## Background Jobs
- Inline execution remains the default (`HEIMDEX_JOB_BACKEND=inline` / `job_queue_backend="immediate"`). Jobs run synchronously via `ImmediateJobBackend`, which spawns a thread executing `app.workers.tasks.run_job`.  
- RQ support is live when Redis is available (`HEIMDEX_JOB_BACKEND=rq`). GCP Tasks backend is stubbed (raises `NotImplementedError` when selected).  
- Job processors (`process_thumbnails_job`, `process_sidecar_job`) probe assets, generate thumbnails, persist manifests, and mark job status.

## Database & Migrations
- Schema defined in `app/db/models.py`. Key tables: `organizations`, `assets`, `sidecars`, `thumbnails`, `jobs`, `audit_events`.  
- Initial migration lives in `migrations/versions/20241010_000001_initial_schema.py`.  
- After `docker compose --profile dev up -d`, run `docker compose exec vna uv run alembic upgrade head` once to bootstrap the Postgres schema before calling ingest endpoints.

## Testing & Quality Gates
- `tests/test_bootstrap_env.py`: Proves the app boots solely from `.env`, mints dev tokens, and accepts a commit flow with a locally staged file.  
- `tests/test_storage_backend.py`: Covers backend selection, allowed scheme logic, and GCS URI parsing.  
- API regression tests (`tests/test_api_v1.py`) walk the ingest flow, idempotency, job orchestration, and sidecar/thumbnail retrieval.  
- Makefile `test` target delegates to `docker compose exec vna uv run pytest -q`.

## Local Development Tips
- **Token minting:** Call `/v1/admin/dev-token` (available only when `HEIMDEX_ENV=development`) to obtain a bearer token for subsequent requests.  
- **File staging:** Place test videos under `derived/uploads/...` to match the `asset_uri` returned by `/v1/ingest/init`. The bind mount makes files instantly visible to the container.  
- **Commit flow quickstart:**  
  1. `curl -X POST /v1/ingest/init …` to get `upload_id` + `asset_uri`.  
  2. Copy your sample video into the indicated path under `derived/`.  
  3. `curl -X POST /v1/ingest/commit …` with the same URI while authenticated.  
- **OpenAPI:** Regenerate via `uv run python -c "from app.main import app; import json, pathlib; pathlib.Path('openapi.json').write_text(json.dumps(app.openapi(), indent=2))"`.

## Known Gaps & Follow-ups
- GCS backend and GCP Tasks job runner are stubs. Implementations will be required before staging/production go-live.  
- Legacy `/metadata` route still exists (though feature-flagged). Plan for full removal once clients migrate.  
- Compose brings up Postgres/Redis for `dev` only; staging/prod profiles are placeholders and require environment-specific configuration.  
- Automatic migration on boot is not yet wired—`alembic upgrade head` must be executed manually after provisioning a fresh database instance.  
- Security model is intentionally minimal: HS256 tokens for dev, optional audience/issuer enforcement. Firebase/OIDC hooks are ready but not integrated in tests.

## Repository Quick Links
- Core settings: `app/core/config.py`  
- Storage abstractions: `app/core/storage.py`  
- Ingest service: `app/services/ingest_service.py`  
- API routers: `app/api/v1/*.py`  
- Sidecar schema definition: `app/ingest/sidecar_schema.py`  
- Tests: `tests/` (notably `test_api_v1.py`, `test_bootstrap_env.py`, `test_storage_backend.py`)  
- Docker/Compose tooling: `Dockerfile`, `docker-compose.yml`, `Makefile`
- Schema validation provided by Pydantic models in `app/ingest/sidecar_schema.py`; `export_schema` snapshots JSON for clients.

## CLI Tooling
- `app/cli.py` offers developer commands: `probe`, `thumbs`, `sidecar`, plus `--check` for dependency validation. Commands reuse ingest helpers and print JSON via `rich`.
- The CLI writes sidecars to `derived/sidecars/{asset_id}.vna.json` when running `sidecar`.

## Logging & Observability
- `configure_logging` sets up structured JSON logging with `structlog` and contextvars; default INFO level.
- `app/main.py` also configures a Rich handler for the legacy routes — the coexistence of two logging setups merits alignment later.
- Job processors bind job id/type to log entries via `get_logger`.

## Testing & Quality Gates
- Pytest suite covers:
  - API happy paths, idempotency, and permission enforcement (`tests/test_api_v1.py`).
  - Hash derivation and Drive identity composition (`tests/test_asset_id.py`).
  - ffprobe parsing edge cases and tag handling (`tests/test_ffprobe_parser.py`).
  - Thumbnail rendering contract (`tests/test_thumbnails.py`).
  - Sidecar schema export and validation (`tests/test_sidecar_schema.py`).
- Fixtures spin up temp SQLite DB, derived directories, real ffmpeg-generated sample media, and JWT helpers. Background jobs run inline during tests.

## Local Development & Deployment
- `Dockerfile` builds on `python:3.11-slim`, installs ffmpeg/ffprobe, Astral `uv`, and runs FastAPI via `uv run fastapi run app/main.py --app app`.
- `docker-compose.yml` provisions Postgres, Redis, and the API container with bind mounts for live code, data, tests, and derived output. Healthcheck hits `/v1/health`.
- `pyproject.toml` lists core deps (FastAPI, Pydantic, SQLAlchemy, async drivers, Redis/RQ, structlog, ffmpeg/python, OpenCV) and optional test extras (pytest/httpx/fakeredis).
- Alembic config (`alembic.ini`) and migrations exist for DB evolution; `app/services/ingest_service.process_sidecar_job` exports schema to `derived/schemas` at runtime.

## Notable Design Decisions & Gaps
- **Dual API implementations:** `app/main.py` conditionally mounts the legacy upload-based endpoint behind `HEIMDEX_ENABLE_LEGACY`. Plan to remove it once consumers migrate.
- **Storage abstraction:** Local remains default. A stub `gcs` backend accepts `gs://` URIs behind the feature flag, with methods still raising `NotImplementedError` until wiring is complete.
- **Idempotency scope:** Enforced per-org and per idempotency key; payload mismatches treated as conflicts rather than reusing existing job with different parameters.
- **Job scheduling:** Immediate backend simplifies dev/testing but still runs jobs in a background thread; production expects Redis-backed RQ.
- **Security model:** JWT validation is minimal (no signature rotation, audience checks disabled, scopes unchecked beyond simple tuple membership). Designed as stub pending integration with upstream auth.
- **Metrics & retries:** Settings hint at retry/backoff logic, but actual retry orchestration is not yet implemented.
- **Tests rely on system ffmpeg/ffprobe:** CI must ensure these binaries exist; Dockerfile already installs them.
- **Derived artefact layout:** Sidecars stored under `derived/{org}/sidecars` while thumbnails move into `derived/{org}/{asset}/thumbs`, with helper to clean temporary `thumbs` staging directory.

## Suggested Follow-ups
- Align logging configuration between legacy and modular app sections, potentially removing the obsolete inline API once clients migrate to `/v1`.
- Implement S3 storage backend or guard configuration to prevent accidental selection.
- Add retry handling for background jobs leveraging `Settings.job_max_retries` parameters.
- Expand admin endpoints for queue visibility/metrics, matching planned roadmap items referenced in `README.md`.
